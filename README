Some code adapted from Envy Labs' http://github.com/envylabs/keymaster
